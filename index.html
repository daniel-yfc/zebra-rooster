<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>å®¢æˆ¶å°å¸³å–®ç”¢ç”Ÿå™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
<style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        /* åˆ—å°æ¨£å¼ */
        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print {
                display: none !important;
            }
            .printable-area {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                font-size: 10pt; /* Adjust print font size */
            }
            [contenteditable="true"], [contenteditable="false"], input, select {
                border-color: transparent !important;
                background-color: transparent !important;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            input[type="date"]::-webkit-calendar-picker-indicator {
                display: none;
            }
            .item-row:hover {
                background-color: transparent !important;
            }
        }
        /* == START: æ–°å¢/ä¿®æ”¹çš„åˆ—å°é‚Šç•Œæ¨£å¼ == */
        @page {
            size: A4;
            margin: 7.5mm;
        }
        /* == END: æ–°å¢/ä¿®æ”¹çš„åˆ—å°é‚Šç•Œæ¨£å¼ == */

        [contenteditable="true"]:focus, input:focus, select:focus {
            outline: none;
            border-color: #3b82f6; /* Tailwind's blue-500 */
            box-shadow: 0 0 0 1px #3b82f6;
        }
        [contenteditable="true"], input[type="number"], input[type="date"], select, .custom-item-input {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px dashed #d1d5db; /* Tailwind's gray-300 */
            transition: all 0.2s ease-in-out;
        }
        .item-row:hover {
             background-color: #f9fafb; /* gray-50 */
        }
        [contenteditable="false"].quantity,
        [contenteditable="false"] {
            background-color: #f3f4f6; /* gray-100 */
            color: #6b7280; /* gray-500 */
            cursor: not-allowed;
        }
        /* == START: æ–°å¢çš„å‚™è¨»æ¨£å¼ == */
        .remark-item {
            display: block;
            margin-bottom: 0.5rem; /* å¢åŠ é …ç›®é–“è· */
        }
        .hanging-indent {
            padding-left: 2em; /* å…§ç¸®ç©ºé–“ */
            text-indent: -2em; /* é¦–è¡Œå‡¸æ’ */
        }
        /* == END: æ–°å¢çš„å‚™è¨»æ¨£å¼ == */
    </style>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const fields = document.querySelectorAll("input, textarea, select");
    fields.forEach(field => {
        const key = "autosave_" + field.name;
        if (localStorage.getItem(key)) {
            field.value = localStorage.getItem(key);
        }
        field.addEventListener("input", () => {
            localStorage.setItem(key, field.value);
        });
    });
});
</script>
<script src="storage.js"></script>
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>
</body>
</html>
<link href="manifest.json" rel="manifest"/>
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log("Service Worker Registered"));
}
</script>
<style>
input.invalid {
  border: 2px solid red;
}
.error-message {
  color: red;
  font-size: 0.9em;
  display: none;
}
</style></head>
<body class="bg-gray-100"><button class="print-preview-button" id="print-preview-btn" onclick="window.print()">é è¦½åˆ—å°</button><button class="export-pdf-button" id="export-pdf-btn" onclick="exportToPDF()">åŒ¯å‡º PDF</button>
<div class="container mx-auto p-4 sm:p-8">
<div class="no-print mb-6 p-4 bg-white rounded-lg shadow-md flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 flex-wrap">
<div class="flex items-center space-x-2">
<label class="text-gray-700 font-medium whitespace-nowrap" for="exchangeRate">æ—¥å¹£åŒ¯ç‡ (JPY â†’ TWD):</label>
<input class="w-28 bg-gray-50 border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2" id="exchangeRate" inputmode="numeric" min="0" oninput="validateNonNegative(this)" step="0.001" type="number" value="0.215"/>
</div>
<div class="flex items-center space-x-4">
<label class="flex items-center space-x-2 cursor-pointer">
<input checked="" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500" id="toggleMileslines" type="checkbox"/>
<span class="text-gray-700">æœ¬æœŸæœ‰ç´¡ç¹”åŠ©åŠ‘</span>
</label>
<label class="flex items-center space-x-2 cursor-pointer">
<input checked="" class="h-5 w-5 text-purple-600 rounded focus:ring-purple-500" id="toggleToshin" type="checkbox"/>
<span class="text-gray-700">æœ¬æœŸæœ‰è¨­å‚™é›¶çµ„ä»¶</span>
</label>
</div>
<button class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow transition-transform transform hover:scale-105" onclick="window.print()">
                ğŸ–¨ï¸ åˆ—å°æ­¤é 
            </button>
</div>
<div class="printable-area bg-white p-6 sm:p-8 rounded-lg shadow-xl text-sm" id="statement">
<header class="text-center mb-6">
<h1 class="text-2xl sm:text-3xl font-bold text-gray-800 tracking-wider" id="statement-title">å®¢æˆ¶å°å¸³å–®</h1>
<p class="text-lg text-gray-500 mt-1" id="statement-month"></p>
</header>
<div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
<div class="space-y-1">
<h2 class="text-base font-semibold border-b pb-2 mb-2 text-gray-700">é–‹ç«‹å–®ä½</h2>
<div class="flex items-center space-x-3">
<div>
<svg enable-background="new 0 0 240 240" height="50" version="1.1" viewbox="0 0 240 240" width="50" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
<g>
<title>Layer 1</title>
<path d="m217.50521,156.63779c-9.83042,9.14591 -19.38131,18.06324 -28.95746,26.95334c-2.23915,2.07874 -4.08286,1.43727 -6.19814,-0.58523c-12.98315,-12.41365 -25.01532,-26.17441 -39.42776,-36.64649c-15.99652,-11.62304 -34.01875,-20.74533 -53.65993,-25.27034c-8.53183,-1.9656 -17.38984,-2.56132 -26.12085,-3.60173c-6.83691,-0.81471 -13.70468,-1.37462 -20.56208,-2.01184c-4.11346,-0.38226 -4.22912,-2.7047 -2.32231,-5.38225c54.91974,-44.1298 62.69379,-44.44441 70.45951,-44.5809c13.26746,-0.23319 25.94275,2.87785 38.32783,7.34586c8.55135,3.08495 17.13845,6.0854 25.59545,9.41362c11.80534,4.64595 22.29765,11.6002 31.70862,19.97169c8.86714,7.88774 17.44178,16.09242 23.26733,26.80707c2.25809,4.1532 2.06006,7.33803 -0.36459,10.85898c-3.79802,5.5152 -7.64756,10.99493 -11.74562,16.72822z" fill="#0A17FF" id="svg_2"></path>
<path d="m172.07539,198.23332c-0.1506,5.87685 -3.80175,9.36592 -9.13589,9.84476c-11.70952,1.05113 -21.64467,-3.90459 -31.38739,-9.18739c-15.77178,-8.55202 -29.54588,-19.78557 -41.26887,-33.31403c-7.83316,-9.03958 -14.9046,-18.7392 -21.91661,-27.63556c-2.33374,8.52312 -2.51499,8.61662 4.62949,22.46437c3.49817,6.78026 7.81423,13.13855 12.19439,20.40863c-8.42984,7.9978 -17.22689,16.24892 -25.91092,24.61733c-5.51324,5.31288 -10.84361,10.81508 -16.28418,16.20391c-3.62337,3.58892 -8.78339,3.62659 -12.04669,-0.30638c-9.43325,-11.36918 -17.24642,-23.8415 -22.67373,-37.55693c-2.59231,-6.55105 -4.80848,-13.76445 -4.87023,-20.69856c-0.13673,-15.35342 7.00889,-26.78456 23.47569,-32.03435c12.70093,-4.04918 25.6542,-2.3551 38.02701,0.32317c19.45851,4.21213 38.78839,9.82921 56.15593,19.88118c11.24858,6.51043 21.74444,14.46251 31.97875,22.52842c5.65162,4.45417 10.26441,10.31032 14.94545,15.87122c1.9074,2.2659 2.75435,5.42445 4.0878,8.59021z" fill="#0A17FF" id="svg_3"></path>
<path d="m143.37626,60.00668c-12.23563,5.35065 -26.0761,3.95385 -20.31647,-2.61959c20.97804,-45.23607 73.61259,-45.95906 93.40516,-41.46369c19.79256,4.49536 8.24643,2.23974 12.26544,3.65553l-85.35413,40.42775z" fill="#FF0101" id="svg_4" stroke="null"></path>
</g>
</svg>
</div>
<div class="text-lg font-bold">æ˜è¯è‚¡ä»½æœ‰é™å…¬å¸</div>
</div>
<div class="text-xs text-gray-600">106415 è‡ºåŒ—å¸‚å¤§å®‰å€æ•¦åŒ–å—è·¯äºŒæ®µ59è™Ÿ18æ¨“</div>
<div class="text-xs text-gray-600">çµ±ä¸€ç·¨è™Ÿï¼š20779196</div>
<div class="text-xs text-gray-600">é›»è©±ï¼š(02)2708-2300  å‚³çœŸï¼š(02)2709-0777</div>
<div class="text-xs text-gray-600">é›»éƒµï¼šThickener@mileslines.ml</div>
<div class="text-xs text-gray-600">è¯çµ¡äººï¼šé™³å°å§</div>
</div>
<div class="space-y-2">
<h2 class="text-base font-semibold border-b pb-2 mb-2 text-gray-700">å®¢æˆ¶è³‡æ–™</h2>
<select class="no-print bg-gray-50 border-gray-300 text-gray-900 text-sm rounded-lg p-1 w-full mb-2" id="customer-select"></select>
<div class="text-lg font-bold" id="customer-name">å®¢æˆ¶å…¨éŠœ</div>
<div class="text-xs text-gray-600" id="customer-address">å¸³å–®åœ°å€ï¼š</div>
<div class="flex items-center text-xs">
<span class="font-medium text-gray-500 w-14">çµ±ä¸€ç·¨è™Ÿï¼š</span>
<span class="text-gray-600 flex-1" id="customer-taxId"></div>
</div>
<div class="flex items-center text-xs">
<span class="font-medium text-gray-500 w-14">é›»è©±ï¼š</span>
<span class="text-gray-600 flex-1" id="customer-phone"></div>
</div>
</div>
</div>
<div class="flex justify-end space-x-8 mb-6 text-xs text-gray-600">
<div class="flex items-center space-x-2">
<strong class="text-gray-800">å°å¸³å–®æ—¥æœŸï¼š</strong>
<input class="bg-gray-50 border-gray-300 text-gray-900 text-xs rounded-lg p-1" id="statement-date" type="date"/>
</div>
</div>
<div class="mb-8" id="mileslines-section">
<h3 class="text-lg font-semibold text-gray-800 mb-3 border-b-2 border-blue-500 pb-2">ç´¡ç¹”åŠ©åŠ‘</h3>
<div class="overflow-x-auto">
<table class="w-full text-left border-collapse mb-4" id="mileslines-items-table">
<thead class="bg-gray-100 border-b-2 border-gray-300">
<tr>
<th class="p-2 text-xs font-semibold text-gray-700 tracking-wider" style="width: 20%;">æ—¥æœŸ</th>
<th class="p-2 text-xs font-semibold text-gray-700 tracking-wider" style="width: 35%;">å“é … / èªªæ˜</th>
<th class="p-2 text-xs font-semibold text-gray-700 tracking-wider text-right" style="width: 15%;">æ•¸é‡(KG)</th>
<th class="p-2 text-xs font-semibold text-gray-700 tracking-wider" style="width: 15%;">å–®åƒ¹ (NT$)</th>
<th class="p-2 text-xs font-semibold text-gray-700 tracking-wider" style="width: 15%;">å°è¨ˆ (NT$)</th>
<th class="p-2 w-10 no-print"></th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<button class="no-print bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded-lg transition-transform transform hover:scale-105" id="add-mileslines-item-btn">
                    + æ–°å¢ä¸€è¡Œç´¡ç¹”åŠ©åŠ‘
                </button>
<div class="flex justify-end mt-4">
<div class="w-full md:w-2/3 lg:w-1/2 space-y-2 text-gray-700">
<div class="flex justify-between items-center">
<span>ç´¡ç¹”åŠ©åŠ‘ (ç¨…å‰)</span>
<div class="flex justify-between font-medium text-gray-800 w-32 text-right">
<span>NT$</span>
<span id="mileslines-subtotal">0</span>
</div>
</div>
<div class="flex justify-between items-center">
<span>ç‡Ÿæ¥­ç¨… (5%)</span>
<div class="flex justify-between font-medium text-gray-800 w-32 text-right">
<span>NT$</span>
<span id="tax">0</span>
</div>
</div>
<div class="flex justify-between items-center border-t pt-2 mt-1 font-semibold text-gray-800">
<span>ç´¡ç¹”åŠ©åŠ‘ã€€åˆè¨ˆ</span>
<div class="flex justify-between font-medium w-32 text-right">
<span>NT$</span>
<span id="mileslines-total">0</span>
</div>
</div>
</div>
</div>
</div>
<div class="mb-8" id="toshin-section">
<div class="flex justify-between items-end border-b-2 border-purple-500 pb-2 mb-3">
<h3 class="text-lg font-semibold text-gray-800">è¨­å‚™é›¶çµ„ä»¶</h3>
<div class="flex items-center space-x-4">
<button class="no-print text-xs bg-purple-100 text-purple-700 hover:bg-purple-200 py-1 px-3 rounded-lg" id="view-parts-btn">é»æ­¤æŸ¥çœ‹è¨­å‚™é›¶çµ„ä»¶éå¾€å“é …æ¸…å–®</button>
<div class="text-xs text-gray-600">
<span class="font-medium">çµå¸³åŒ¯ç‡ï¼š</span> 1 JPY = <span class="font-semibold text-purple-700" id="rate-display">0.215</span> TWD
                        </div>
</div>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left border-collapse mb-4" id="toshin-items-table">
<thead class="bg-gray-100 border-b-2 border-gray-300">
<tr>
<th class="p-2 text-xs font-semibold text-gray-700 tracking-wider" style="width: 15%;">æ—¥æœŸ</th>
<th class="p-2 text-xs font-semibold text-gray-700 tracking-wider" style="width: 25%;">å“é … / èªªæ˜</th>
<th class="p-2 text-xs font-semibold text-gray-700 tracking-wider text-right" style="width: 10%;">æ•¸é‡</th>
<th class="p-2 text-xs font-semibold text-gray-700 tracking-wider text-right" style="width: 15%;">å–®åƒ¹ (JPÂ¥)</th>
<th class="p-2 text-xs font-semibold text-gray-700 tracking-wider text-right" style="width: 15%;">å°è¨ˆ (JPÂ¥)</th>
<th class="p-2 text-xs font-semibold text-gray-700 tracking-wider" style="width: 20%;">å°è¨ˆ (NT$)</th>
<th class="p-2 w-10 no-print"></th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<button class="no-print bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded-lg transition-transform transform hover:scale-105" id="add-toshin-item-btn">
                    + æ–°å¢ä¸€è¡Œè¨­å‚™é›¶çµ„ä»¶
                </button>
<div class="flex justify-end mt-4">
<div class="w-full md:w-2/3 lg:w-1/2 space-y-2 text-gray-700">
<div class="flex justify-between items-center border-t pt-2 font-semibold text-gray-800">
<span>è¨­å‚™é›¶çµ„ä»¶ åˆè¨ˆ</span>
<div class="flex justify-between font-medium w-32 text-right">
<span>NT$</span>
<span id="toshin-total">0</span>
</div>
</div>
</div>
</div>
</div>
<div class="flex justify-end mt-8">
<div class="w-full md:w-2/3 lg:w-1/2">
<div class="flex justify-between items-center border-t-2 border-gray-800 pt-2 text-base font-bold">
<span class="text-gray-800">æœ¬æœŸå¸³æ¬¾ç¸½é¡</span>
<div class="flex justify-between text-red-600 w-32 text-right">
<span>NT$</span>
<span id="grand-total">0</span>
</div>
</div>
</div>
</div>
<div class="mt-12 text-sm text-gray-600">
    <h3 class="font-semibold text-gray-700 mb-2">å‚™è¨»äº‹é …ï¼š</h3>
    <div class="p-2 border rounded-md min-h-[80px]" id="remarks-container">
        </div>
</div>
<div class="mt-16 grid grid-cols-3 gap-8 text-center text-xs">
<div>
<div class="border-t-2 border-gray-300 pt-2">è£½è¡¨ Prepared by</div>
</div>
<div>
<div class="border-t-2 border-gray-300 pt-2">ç¢ºèª Confirmed by</div>
</div>
<div>
<div class="border-t-2 border-gray-300 pt-2">æ ¸å‡† Approved by</div>
</div>
</div>
</div>
</div>
<div class="no-print fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4" id="parts-modal">
<div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
<div class="sticky top-0 bg-white p-4 border-b flex justify-between items-center">
<h2 class="text-xl font-bold text-gray-800">æ±ä¼¸é›¶çµ„ä»¶å“é …åƒè€ƒ</h2>
<button class="text-gray-500 hover:text-gray-800 text-2xl" id="close-modal-btn">Ã—</button>
</div>
<div class="p-6" id="modal-content">
</div>
</div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // =======================================================
        // == è«‹åœ¨é€™è£¡ç·¨è¼¯æ‚¨çš„è³‡æ–™æ¸…å–® ==
        // =======================================================
        const customerList = [
            { name: "è‹±å‹¤å¸ƒæ¥­æœ‰é™å…¬å¸å…¨èˆˆå» ", address: "509004 å½°åŒ–ç¸£ä¼¸æ¸¯é„‰å…¨èˆˆå·¥æ¥­å€å·¥æ±ä¸€è·¯41è™Ÿ", taxId: "23690554", phone: "(04) 797-8089" },
            { name: "ç¿”é€¸è²¿æ˜“è‚¡ä»½æœ‰é™å…¬å¸", address: "334019 æ¡ƒåœ’å¸‚å…«å¾·å€å¤§èˆˆè·¯110è™Ÿ14æ¨“", taxId: "04243774", phone: "(03) 218-3944" },
            { name: "å¯Œéƒæœ‰é™å…¬å¸", address: "330477 æ¡ƒåœ’å¸‚æ¡ƒåœ’å€é¾œå±±å·¥æ¥­å€èˆˆéš†è·¯9è™Ÿ", taxId: "83641467", phone: "(03) 362-5231" },
            { name: "è¯åŸæœ‰é™å…¬å¸", address: "333024 æ¡ƒåœ’å¸‚é¾œå±±å€æµ·èè·¯16å··8ä¹‹1è™Ÿ", taxId: "43783502", phone: "(03) 350-7016" },
            { name: "æ–°ç‘å€¡ä¼æ¥­è‚¡ä»½æœ‰é™å…¬å¸", address: "333029 æ¡ƒåœ’å¸‚é¾œå±±å€æ±èˆŠè·¯è¡—100è™Ÿ", taxId: "07620770", phone: "(03) 329-4856" },
            { name: "ç´¡é‚‘è±å¯¦æ¥­æœ‰é™å…¬å¸", address: "338013 æ¡ƒåœ’å¸‚è˜†ç«¹å€å®ç«¹é‡Œå¤§ç«¹åŒ—è·¯331å··53è™Ÿ", taxId: "84794659", phone: "(03) 313-2885" },
            { name: "ç´¡è£•è±è‚¡ä»½æœ‰é™å…¬å¸", address: "338013 æ¡ƒåœ’å¸‚è˜†ç«¹å€å¤§ç«¹åŒ—è·¯331å··51è™Ÿ", taxId: "80013153", phone: "(03) 313-2885" },
            { name: "èˆˆé‚¦å°æŸ“å» è‚¡ä»½æœ‰é™å…¬å¸", address: "236044 æ–°åŒ—å¸‚åœŸåŸå€ç¦å®‰è¡—114è™Ÿ", taxId: "33420382", phone: "(02) 2268-1290" },
            { name: "è‡ªè¡Œè¼¸å…¥", address: "", taxId: "", phone: "" }
        ];

        const mileslinesProductList = [
            { description: 'é…’çŸ³é…¸', price: 70 },
            { description: 'ç³Šæ–™ MAX8', price: 160 },
            { description: 'è±†ç³Š HS', price: 60 },
            { description: 'ç³Šæ–™ 3A', price: 120 },
            { description: 'ç³Šæ–™ MY/12', price: 130 },
            { description: 'ç³Šæ–™ TA/12', price: 130 },
            { description: 'ç³Šæ–™ TA/8', price: 120 },
            { description: 'ç³Šæ–™ EXBA', price: 150 },
            { description: 'ç³Šæ–™ EX', price: 150 },
            { description: 'å°èŠ±æ²¹', price: 280 },
            { description: 'å°å¸ƒæ²¹', price: 250 },
            { description: 'ç³Šæ–™ PAN NEW', price: 90 },
            { description: 'ç³Šæ–™ JOY/EXTRA', price: 70 },
            { description: 'è‡ªè¡Œè¼¸å…¥', price: 0 }
        ];

        const toshinServiceList = [
            // è‡ªå‹•åŒ–æ§åˆ¶
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "æ§åˆ¶å™¨", item: "æ§åˆ¶å™¨ï¼šå®šä½æ§åˆ¶å™¨ã€åºåˆ—æ§åˆ¶å™¨ã€æ™‚åºæ§åˆ¶å™¨", examples: ["SQC-5", "SQC-6", "SQC-T2", "UD-F70", "FX3G-24M", "NAiS KT4", "FRC100A-G02", "JAMSC-B2605", "JAMSC-C389", "JAMSC-B1090B"] },
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "æ§åˆ¶å™¨", item: "æ§åˆ¶å™¨ï¼šé‹ç®—æ¨¡çµ„", examples: ["Q01CPU", "Q02UCPU", "NC1P-EO", "DDSCR-U84S", "KEYENCE KZ-300", "KV-24AT", "FXIN-24MT"] },
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "æ§åˆ¶å™¨", item: "æ§åˆ¶å™¨ï¼šè¼¸å‡ºå…¥æ¨¡çµ„", examples: ["JAMSC-B2603", "JAMSC-B2605", "JAMSC-B2833", "KZ-C32X", "JAMSC-B2110A"] },
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "æ§åˆ¶å™¨", item: "æ§åˆ¶å™¨ï¼šé¡æ¯”æ¨¡çµ„", examples: ["Q64DAN", "JAMSC-B1054"] },
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "æ§åˆ¶å™¨", item: "æ§åˆ¶å™¨ï¼šé€šè¨Šæ¨¡çµ„", examples: ["JAMSC-C8610", "ç¶²è·¯æ¨¡çµ„: QJG1BT 11N å¯¾å¿œCC-Link", "FX2N-32CCL"] },
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "æ§åˆ¶å™¨", item: "æ§åˆ¶å™¨ï¼šé›»æºæ¨¡çµ„", examples: ["Q62P", "S8VS-03024"] },
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "æ§åˆ¶å™¨", item: "æ§åˆ¶å™¨ï¼šåŸºæœ¬æ¨¡çµ„", examples: [] },
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "é©…å‹•å™¨", item: "ä¼ºæœé¦¬é”é©…å‹•å™¨(Servopack)", examples: ["SGDH-XXXX", "SGDV-XXXX", "SD2A-XXXX"] },
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "é©…å‹•å™¨", item: "è®Šé »å™¨ (Inverter)", examples: ["FVR", "CIMR", "VF-S9"] },
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "äººæ©Ÿä»‹é¢", item: "è§¸æ§é¢æ¿", examples: ["GP-4301", "GP-2400", "GT-1150"] },
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "æ„Ÿæ¸¬å™¨", item: "è¿‘æ¥é–‹é—œã€æ—‹è½‰ç·¨ç¢¼å™¨, æ¸¬é€Ÿç™¼é›»æ©Ÿã€å…‰å­¸æ„Ÿæ‡‰å™¨", examples: ["E2E-X8MD1", "HES-01", "RP-112-AC", "RE-010-DC"] },
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "é›»å­å…ƒä»¶", item: "ç¹¼é›»å™¨ã€é«˜å£“é›»ç£æ¥è§¸å™¨(HGR)ã€é›»ç£è½‰æ›å™¨ã€é›»é˜»", examples: ["HI-20EG"] },
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "é›»çºœ", item: "é›»çºœã€æ’ç·šã€é€£æ¥å™¨ã€æ’é ­", examples: [] },
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "é›»å­å…ƒä»¶", item: "é–‹é—œã€æŒ‰éˆ•ã€ç«¯å­å°", examples: ["SB-2NB/21", "U-84S", "PUL-10A-10U"] },			
            { category: "è‡ªå‹•åŒ–æ§åˆ¶", subCategory: "é›»å­å…ƒä»¶", item: "é›»å­é›¶ä»¶ï¼šå°åˆ·é›»è·¯æ¿ï¼ˆPCBï¼‰ã€é›»é˜»ã€è®Šå£“å™¨", examples: ["FVR3 7E9S-2TS", "FRN3.7C1S-2TS"] },
			
            // æ©Ÿæ¢°èˆ‡å‚³å‹•
            { category: "æ©Ÿæ¢°å‚³å‹•", subCategory: "é‹å‹•çµæ§‹", item: "è»¸æ‰¿èˆ‡æ»‘å‹•ä»¶ï¼šæ»‘å‹•è»¸æ‰¿", examples: ["Slide Shoe", "KRD065"] },
            { category: "æ©Ÿæ¢°å‚³å‹•", subCategory: "é‹å‹•çµæ§‹", item: "è»¸æ‰¿èˆ‡æ»‘å‹•ä»¶ï¼šæ»‘è»Œ", examples: ["Sliding Sleeve"] },
            { category: "æ©Ÿæ¢°å‚³å‹•", subCategory: "é‹å‹•çµæ§‹", item: "è»¸æ‰¿èˆ‡æ»‘å‹•ä»¶ï¼šæ¨åŠ›è»¸æ‰¿", examples: ["Thrust Bearing"] },
            { category: "æ©Ÿæ¢°å‚³å‹•", subCategory: "é‹å‹•çµæ§‹", item: "æ»¾è¼ªèˆ‡çš®å¸¶ï¼šå°è¼¥ã€èª¿æ•´è¼¥", examples: [] },
            { category: "æ©Ÿæ¢°å‚³å‹•", subCategory: "é‹å‹•çµæ§‹", item: "æ»¾è¼ªèˆ‡çš®å¸¶ï¼šå°èŠ±çš®å¸¶", examples: [] },
            { category: "æ©Ÿæ¢°å‚³å‹•", subCategory: "é‹å‹•çµæ§‹", item: "æ»¾è¼ªèˆ‡çš®å¸¶ï¼šæ™‚è¦çš®å¸¶", examples: [] },
            { category: "æ©Ÿæ¢°å‚³å‹•", subCategory: "é‹å‹•çµæ§‹", item: "è¯è»¸å™¨èˆ‡åˆ¶å‹•ï¼šè¯è»¸å™¨", examples: [] },
            { category: "æ©Ÿæ¢°å‚³å‹•", subCategory: "é‹å‹•çµæ§‹", item: "è¯è»¸å™¨èˆ‡åˆ¶å‹•ï¼šé›»ç£é›¢åˆå™¨åŠç…è»Šè¹„ç‰‡", examples: ["Brake Shoe", "Brake Piece"] },
            { category: "æ©Ÿæ¢°å‚³å‹•", subCategory: "é‹å‹•çµæ§‹", item: "çµæ§‹éƒ¨ä»¶ï¼šé€£æ¡¿ã€è»¸ã€é½’è¼ª", examples: ["Lever"] },
            { category: "æ©Ÿæ¢°å‚³å‹•", subCategory: "é‹å‹•è¼”åŠ©", item: "æ°£å£“å…ƒä»¶ï¼šæ°£ç¼¸ã€é›»ç£é–¥ã€ç®¡ç·š", examples: ["Air Cylinder", "Solenoid Valve SY5120-5MU-C6-F2"] },
            { category: "æ©Ÿæ¢°å‚³å‹•", subCategory: "é‹å‹•è¼”åŠ©", item: "æ²¹å£“å…ƒä»¶ï¼šæ²¹å£“æ³µ, æ²¹å£“ç¼¸ã€æ²¹å£“æ¿¾èŠ¯", examples: ["NCLFZ-15A", "Vane Pump PVB29-FR5-20-CMC-11-J", "Vane Pump SY5120-5MU-C6-F2", "Piston Pump  PVB29-FRS-20-CMC-11-JA"] },
            { category: "æ©Ÿæ¢°å‚³å‹•", subCategory: "è¼”åŠ©è£ç½®", item: "èª¿æ•´è£ç½®ï¼šå‹æ¡†èª¿æ•´è£ç½®", examples: [] },
            { category: "æ©Ÿæ¢°å‚³å‹•", subCategory: "è¼”åŠ©è£ç½®", item: "èª¿æ•´è£ç½®ï¼šåˆ»åº¦ç­’", examples: ["7E9S-2TS", "åœ“å½¢åˆ»åº¦ç­’", "å››è§’å‹ç›®ç››ç­’"]},
            { category: "æ©Ÿæ¢°å‚³å‹•", subCategory: "è¼”åŠ©è£ç½®", item: "èª¿æ•´è£ç½®ï¼šå½ˆç°§ã€èºçµ²", examples: [] },
            // è€—æèˆ‡å·¥å…·
            { category: "è€—æ", subCategory: "ç”Ÿç”¢è€—æ", item: "å¢¨æ°´ã€å™´é ­ã€å¢¨ç®¡", examples: ["FJ-600", "SP8018 KBR", "SJ-540"] },
            { category: "è€—æ", subCategory: "ç”Ÿç”¢è€—æ", item: "ç¶²å¸ƒï¼šèšé…¯ç¶²ã€æ¯›æ°ˆã€è¼¸é€å¸¶ç¶²", examples: [] },
            { category: "è€—æ", subCategory: "ç¶­è­·è€—æ", item: "æ¸…æ½”ç”¨å“ï¼šæ©¡è† åˆ®åˆ€ã€æ¸…æ½”æ£’", examples: ["æ¿¾å¿ƒ: OFS-12-JA-10-J"] },
            { category: "è€—æ", subCategory: "ç¶­è­·è€—æ", item: "å…¶ä»–è€—æï¼šç¢³åˆ·ã€æ²¹å°ã€æ©¡è† æ¿", examples: [] },
            // Special Items
            { category: "ç‰¹æ®Šé …ç›®", description: 'é‹è²»', priceJPY: 0 },
            { category: "ç‰¹æ®Šé …ç›®", description: 'è‡ªè¡Œè¼¸å…¥', priceJPY: 0 }
        ];
        // =======================================================


        const mileslinesTableBody = document.querySelector('#mileslines-items-table tbody');
        const toshinTableBody = document.querySelector('#toshin-items-table tbody');
        const addmileslinesItemBtn = document.getElementById('add-mileslines-item-btn');
        const addtoshinItemBtn = document.getElementById('add-toshin-item-btn');
        const exchangeRateInput = document.getElementById('exchangeRate');
        const rateDisplay = document.getElementById('rate-display');

        const statementDateInput = document.getElementById('statement-date');
        const statementMonthEl = document.getElementById('statement-month');
        
        const toggleMileslines = document.getElementById('toggleMileslines');
        const toggleToshin = document.getElementById('toggleToshin');
        const mileslinesSection = document.getElementById('mileslines-section');
        const toshinSection = document.getElementById('toshin-section');
        
        // Modal elements
        const partsModal = document.getElementById('parts-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const viewPartsBtn = document.getElementById('view-parts-btn');
        const modalContent = document.getElementById('modal-content');

        // == START: å‚™è¨»å®¹å™¨ ==
        const remarksContainer = document.getElementById('remarks-container');
        // == END: å‚™è¨»å®¹å™¨ ==
        
        // Customer Info Elements
        const customerSelect = document.getElementById('customer-select');
        const customerNameEl = document.getElementById('customer-name');
        const customerAddressEl = document.getElementById('customer-address');
        const customerTaxIdEl = document.getElementById('customer-taxId');
        const customerPhoneEl = document.getElementById('customer-phone');

        // Populate customer dropdown
        customerList.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.name;
            option.textContent = customer.name;
            customerSelect.appendChild(option);
        });

        // Handle customer selection change
        customerSelect.addEventListener('change', (e) => {
            const selectedName = e.target.value;
            const customerData = customerList.find(c => c.name === selectedName);

            if (customerData) {
                const isOther = selectedName === 'è‡ªè¡Œè¼¸å…¥';
                
                customerNameEl.textContent = isOther ? 'è«‹æ‰‹å‹•è¼¸å…¥å®¢æˆ¶åç¨±' : customerData.name;
                customerAddressEl.textContent = customerData.address;
                customerTaxIdEl.textContent = customerData.taxId;
                customerPhoneEl.textContent = customerData.phone;
                
                customerNameEl.contentEditable = isOther;
                customerAddressEl.contentEditable = isOther;
                customerTaxIdEl.contentEditable = isOther;
                customerPhoneEl.contentEditable = isOther;

                [customerNameEl, customerAddressEl, customerTaxIdEl, customerPhoneEl].forEach(el => {
                    el.classList.toggle('bg-gray-50', isOther);
                });
                
                if (isOther) {
                    customerNameEl.focus();
                }
            }
        });

        const updateBillingPeriodText = (dateStr) => {
            const selectedDate = new Date(dateStr + 'T00:00:00');
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth(); // 0-11
            
            statementMonthEl.textContent = `${year} å¹´ ${month + 1} æœˆ`;
        };

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        statementDateInput.value = todayStr;
        updateBillingPeriodText(todayStr);
        statementDateInput.addEventListener('change', (e) => updateBillingPeriodText(e.target.value));

        const formatNumber = (amount) => new Intl.NumberFormat('zh-TW').format(Math.round(amount));

        // == START: æ–°å¢/ä¿®æ”¹çš„å‚™è¨»æ›´æ–°å‡½æ•¸ ==
        const updateRemarks = () => {
            const hasMileslines = toggleMileslines.checked;
            const hasToshin = toggleToshin.checked;
            let remarks = [];

            remarks.push('<p class="remark-item">â€» å¦‚å°æœ¬æœŸå°å¸³å–®é …ç›®é‡‘é¡æˆ–ä¸‹è¿°å‚™è¨»äº‹é …æœ‰æ‰€å‚è©¢ï¼Œè«‹å„˜å¿«èˆ‡æœ¬å…¬å¸è¯ç¹«ã€‚</p>');

            if (hasToshin) {
                remarks.push(
                    '<p class="remark-item hanging-indent">â€» è¨­å‚™é›¶çµ„ä»¶æ¬¾ï¼šæ”¯ç¥¨è«‹ä»¥ã€Œé™³å¥•ç”«ã€ç‚ºå—æ¬¾äººé–‹ç«‹ï¼Œä»¥ä¾¿ä»£ç†æ”¶ä»˜æ¬¾é …ã€‚<br>' +
                    '&nbsp;&nbsp;&nbsp;&nbsp;æé†’æ‚¨ï¼Œé›¶çµ„ä»¶è¼¸å…¥åœ‹å…§æ™‚ï¼Œæµ·é—œå·²ä¾ã€Šç‡Ÿæ¥­ç¨…æ³•ã€‹ç¬¬41æ¢ä»£å¾µç‡Ÿæ¥­ç¨…ï¼Œè²´å…¬å¸å¾—æ†‘ç¨…è²»æ”¶æ“šæ‰£æŠµé€²é …ç¨…é¡ã€‚</p>'
                );
            }
            if (hasMileslines) {
                 remarks.push('<p class="remark-item">â€» ç´¡ç¹”åŠ©åŠ‘æ¬¾é …ï¼šæ”¯ç¥¨è«‹ä»¥ã€Œæ˜è¯è‚¡ä»½æœ‰é™å…¬å¸ã€ç‚ºå—æ¬¾äººé–‹ç«‹ã€‚</p>');
            }
            
            remarksContainer.innerHTML = remarks.join('');
        };
        // == END: æ–°å¢/ä¿®æ”¹çš„å‚™è¨»æ›´æ–°å‡½æ•¸ ==
        
        const updateTotals = () => {
            let mileslinesSubtotal = 0;
            if (toggleMileslines.checked) {
                mileslinesTableBody.querySelectorAll('.item-row').forEach(row => {
                    const quantity = parseFloat(row.querySelector('.quantity').textContent.replace(/,/g, '')) || 0;
                    const price = parseFloat(row.querySelector('.price').textContent.replace(/,/g, '')) || 0;
                    const total = quantity * price;
                    row.querySelector('.total').textContent = formatNumber(total);
                    mileslinesSubtotal += total;
                });
            }

            let toshinTotalTWD = 0;
            if (toggleToshin.checked) {
                const exchangeRate = parseFloat(exchangeRateInput.value) || 0;
                if (rateDisplay) rateDisplay.textContent = exchangeRate.toString();
                
                toshinTableBody.querySelectorAll('.item-row').forEach(row => {
                    const isShipping = row.querySelector('.item-select').value === 'é‹è²»';
                    let totalJPY;

                    if (isShipping) {
                        // For shipping, the total JPY is entered directly into the subtotal field
                        totalJPY = parseFloat(row.querySelector('.total-jpy-input').value.replace(/,/g, '')) || 0;
                    } else {
                        const quantity = parseFloat(row.querySelector('.quantity').textContent.replace(/,/g, '')) || 0;
                        const priceJPY = parseFloat(row.querySelector('.price-jpy').textContent.replace(/,/g, '')) || 0;
                        totalJPY = quantity * priceJPY;
                    }

                    const totalTWD = Math.round(totalJPY * exchangeRate);
                    
                    // Update display for non-shipping rows
                    if (!isShipping) {
                         row.querySelector('.total-jpy').textContent = formatNumber(totalJPY);
                    }
                    row.querySelector('.total-twd').textContent = formatNumber(totalTWD);
                    toshinTotalTWD += totalTWD;
                });
            }
            
            const tax = Math.round(mileslinesSubtotal * 0.05);
            const mileslinesTotal = mileslinesSubtotal + tax;
            const grandTotal = mileslinesTotal + toshinTotalTWD;

            document.getElementById('mileslines-subtotal').textContent = formatNumber(mileslinesSubtotal);
            document.getElementById('tax').textContent = formatNumber(tax);
            document.getElementById('mileslines-total').textContent = formatNumber(mileslinesTotal);
            document.getElementById('toshin-total').textContent = formatNumber(toshinTotalTWD);
            document.getElementById('grand-total').textContent = formatNumber(grandTotal);

            // Update remarks whenever totals are updated
            updateRemarks();
        };
        
        const createmileslinesItemRow = (date, selectedDesc, qty, price) => {
            const row = document.createElement('tr');
            row.classList.add('item-row', 'border-b', 'border-gray-200', 'text-sm');
            let optionsHtml = mileslinesProductList.map(p => `<option value="${p.description}" data-price="${p.price}">${p.description}</option>`).join('');
            
            row.innerHTML = `
                <td class="p-2 align-top"><input type="date" class="item-date bg-gray-50 border-gray-300 text-gray-900 text-xs rounded-lg p-1 w-full"></td>
                <td class="p-2 align-top">
                    <select class="item-select bg-gray-50 border-gray-300 text-gray-900 text-xs rounded-lg p-1 w-full">${optionsHtml}</select>
                    <input type="text" class="custom-item-input hidden bg-gray-50 border-gray-300 text-gray-900 text-xs rounded-lg p-1 w-full mt-1" placeholder="è«‹è¼¸å…¥è‡ªè¨‚å“é …">
                </td>
                <td class="p-2 align-top text-right"><div contenteditable="true" class="quantity">${qty}</div></td>
                <td class="p-2 align-top"><div class="flex justify-between w-full"><span class="pr-2">NT$</span><div contenteditable="true" class="price text-right flex-grow">${price}</div></div></td>
                <td class="p-2 align-top"><div class="flex justify-between w-full font-medium text-gray-800"><span class="pr-2">NT$</span><span class="total">0</span></div></td>
                <td class="p-2 align-top text-center no-print"><button class="remove-item-btn text-red-500 hover:text-red-700 font-bold">âœ•</button></td>
            `;
            row.querySelector('.item-date').value = date;
            row.querySelector('.item-select').value = selectedDesc;
            mileslinesTableBody.appendChild(row);
        };

        const createtoshinItemRow = (date, selectedDesc, qty, priceJPY) => {
            const row = document.createElement('tr');
            row.classList.add('item-row', 'border-b', 'border-gray-200', 'text-sm');
            
            const groupedByCategory = toshinServiceList.reduce((acc, item) => {
                const category = item.category || 'ç‰¹æ®Šé …ç›®';
                (acc[category] = acc[category] || []).push(item);
                return acc;
            }, {});

            let optionsHtml = '';
            for (const category in groupedByCategory) {
                if (category === 'ç‰¹æ®Šé …ç›®') continue;
                optionsHtml += `<optgroup label="${category}">`;
                const uniqueTypesMap = new Map();
                groupedByCategory[category].forEach(p => {
                    const baseDesc = p.item.split('ï¼š')[0];
                    if (!uniqueTypesMap.has(baseDesc)) {
                        uniqueTypesMap.set(baseDesc, p);
                    }
                });
                uniqueTypesMap.forEach((item, baseDesc) => {
                    optionsHtml += `<option value="${item.subCategory} > ${baseDesc}" data-price="0">${item.subCategory} > ${baseDesc}</option>`;
                });
                optionsHtml += `</optgroup>`;
            }
            if (groupedByCategory['ç‰¹æ®Šé …ç›®']) {
                groupedByCategory['ç‰¹æ®Šé …ç›®'].forEach(p => {
                    optionsHtml += `<option value="${p.description}" data-price="${p.priceJPY}">${p.description}</option>`;
                });
            }


            const shippingOptions = ['EMS', 'OCS', 'UPS', 'Fedex', 'DHL'].map(s => `<option value="${s}">${s}</option>`).join('');

            row.innerHTML = `
                <td class="p-2 align-top"><input type="date" class="item-date bg-gray-50 border-gray-300 text-gray-900 text-xs rounded-lg p-1 w-full"></td>
                <td class="p-2 align-top">
                    <select class="item-select bg-gray-50 border-gray-300 text-gray-900 text-xs rounded-lg p-1 w-full">${optionsHtml}</select>
                    <div class="details-container mt-1 space-y-1">
                        <input type="text" class="model-input hidden bg-gray-50 border-gray-300 text-gray-900 text-xs rounded-lg p-1 w-full" placeholder="è«‹è¼¸å…¥å‹è™Ÿ/è¦æ ¼">
                        <select class="shipping-carrier hidden bg-gray-50 border-gray-300 text-gray-900 text-xs rounded-lg p-1 w-full">${shippingOptions}</select>
                        <input type="text" class="custom-item-input hidden bg-gray-50 border-gray-300 text-gray-900 text-xs rounded-lg p-1 w-full mt-1" placeholder="è«‹è¼¸å…¥è‡ªè¨‚å“é …">
                    </div>
                </td>
                <td class="p-2 align-top text-right"><div contenteditable="true" class="quantity">${qty}</div></td>
                <td class="p-2 align-top"><div class="price-jpy-container flex justify-between w-full"><span class="pr-2">Â¥</span><div contenteditable="true" class="price-jpy text-right flex-grow">${priceJPY}</div></div></td>
                <td class="p-2 align-top"><div class="total-jpy-container flex justify-between w-full font-medium text-gray-800"><span class="pr-2">Â¥</span><span class="total-jpy">0</span></div></td>
                <td class="p-2 align-top"><div class="flex justify-between w-full font-medium text-gray-800"><span class="pr-2">NT$</span><span class="total-twd">0</span></div></td>
                <td class="p-2 align-top text-center no-print"><button class="remove-item-btn text-red-500 hover:text-red-700 font-bold">âœ•</button></td>
            `;
            row.querySelector('.item-date').value = date;
            const selectEl = row.querySelector('.item-select');
            if (selectEl.querySelector(`option[value="${selectedDesc}"]`)) {
                 selectEl.value = selectedDesc;
            } else {
                 selectEl.selectedIndex = 0;
            }
           
            toshinTableBody.appendChild(row);
            selectEl.dispatchEvent(new Event('change'));
        };
        
        addmileslinesItemBtn.addEventListener('click', () => { createmileslinesItemRow(new Date().toISOString().split('T')[0], mileslinesProductList[0].description, 1, mileslinesProductList[0].price); updateTotals(); });
        addtoshinItemBtn.addEventListener('click', () => { createtoshinItemRow(new Date().toISOString().split('T')[0], "æ§åˆ¶å™¨ > åºåˆ—æ§åˆ¶å™¨ (PLC)", 1, 0); updateTotals(); });
        exchangeRateInput.addEventListener('input', updateTotals);

        const updatemileslinesSectionVisibility = () => {
             mileslinesSection.style.display = toggleMileslines.checked ? 'block' : 'none';
             updateTotals();
        };

        const updatetoshinSectionVisibility = () => {
            toshinSection.style.display = toggleToshin.checked ? 'block' : 'none';
            updateTotals();
        };

        toggleMileslines.addEventListener('change', updatemileslinesSectionVisibility);
        toggleToshin.addEventListener('change', updatetoshinSectionVisibility);
        
        function setupTableListeners(tableBody) {
            tableBody.addEventListener('input', (e) => {
                if (e.target.matches('.quantity, .price, .price-jpy, .total-jpy-input')) {
                    const originalText = e.target.textContent || e.target.value;
                    let newText = originalText.replace(/[^0-9,.]/g, '');
                    if (e.target.tagName === 'INPUT') {
                         e.target.value = newText;
                    } else {
                         e.target.textContent = newText;
                    }

                    if ((e.target.textContent || e.target.value) !== originalText) {
                        const range = document.createRange(), sel = window.getSelection();
                        const targetNode = e.target.tagName === 'INPUT' ? e.target : e.target;
                        if (targetNode.firstChild) {
                             range.selectNodeContents(targetNode);
                             range.collapse(false);
                             sel.removeAllRanges();
                             sel.addRange(range);
                        }
                    }
                    updateTotals();
                }
            });

            tableBody.addEventListener('change', (e) => {
                if (e.target.matches('.item-select')) {
                    const select = e.target;
                    const row = select.closest('.item-row');
                    const detailsContainer = row.querySelector('.details-container');
                    const modelInput = detailsContainer?.querySelector('.model-input');
                    const shippingCarrierSelect = detailsContainer?.querySelector('.shipping-carrier');
                    const customInput = row.querySelector('.custom-item-input, .details-container .custom-item-input');
                    const quantityCell = row.querySelector('.quantity');
                    const priceCell = row.querySelector('.price, .price-jpy');
                    const priceContainer = row.querySelector('.price-jpy-container');
                    const totalJPYContainer = row.querySelector('.total-jpy-container');
                    const selectedOption = select.options[select.selectedIndex];
                    const price = selectedOption.dataset.price;
                    
                    // Reset to default state
                    if (modelInput) modelInput.classList.add('hidden');
                    if (shippingCarrierSelect) shippingCarrierSelect.classList.add('hidden');
                    if(customInput) customInput.classList.add('hidden');
                    
                    quantityCell.contentEditable = true;
                    quantityCell.classList.remove('bg-gray-100', 'text-gray-500', 'cursor-not-allowed');
                    priceContainer.innerHTML = `<span class="pr-2">Â¥</span><div contenteditable="true" class="price-jpy text-right flex-grow">${price || 0}</div>`;
                    totalJPYContainer.innerHTML = `<span class="pr-2">Â¥</span><span class="total-jpy">0</span>`;


                    if (select.value === 'é‹è²»') {
                        if (shippingCarrierSelect) shippingCarrierSelect.classList.remove('hidden');
                        quantityCell.textContent = 'â€”';
                        quantityCell.contentEditable = false;
                        quantityCell.classList.add('bg-gray-100', 'text-gray-500', 'cursor-not-allowed');
                        priceContainer.innerHTML = '<div class="w-full text-center text-gray-500">â€”</div>';
                        totalJPYContainer.innerHTML = `<span class="pr-2">Â¥</span><input type="text" class="total-jpy-input bg-gray-50 border-gray-300 text-gray-900 text-xs rounded-lg p-1 w-full text-right" value="0">`;
                    } else if (select.value.includes('è‡ªè¡Œè¼¸å…¥')) {
                        if(customInput) customInput.classList.remove('hidden');
                        customInput.focus();
                    } else { // Standard item
                        if(modelInput) modelInput.classList.remove('hidden');
                        if (priceCell) {
                            priceCell.textContent = price;
                        }
                    }
                    updateTotals();
                }
            });

            tableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-item-btn')) {
                    e.target.closest('.item-row').remove();
                    updateTotals();
                }
            });
        }
        
        setupTableListeners(mileslinesTableBody);
        setupTableListeners(toshinTableBody);

        // Modal Logic
        function populateModal() {
            const grouped = toshinServiceList.reduce((acc, item) => {
                if(item.category === 'ç‰¹æ®Šé …ç›®') return acc;
                (acc[item.category] = acc[item.category] || {})[item.subCategory] = (acc[item.category][item.subCategory] || []);
                acc[item.category][item.subCategory].push(item);
                return acc;
            }, {});
            
            let html = '';
            for(const category in grouped) {
                html += `<div class="mb-4"><h3 class="text-lg font-bold text-purple-700 mb-2">${category}</h3>`;
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">';
                for(const subCategory in grouped[category]) {
                    html += `<div><h4 class="font-semibold text-gray-800">${subCategory}</h4><ul class="list-disc list-inside text-gray-600 text-xs">`;
                    grouped[category][subCategory].forEach(item => {
                        html += `<li>${item.item}${item.examples.length > 0 ? ` (${item.examples.join(', ')})` : ''}</li>`;
                    });
                    html += `</ul></div>`;
                }
                html += '</div></div>';
            }
            modalContent.innerHTML = html;
        }

        viewPartsBtn.addEventListener('click', () => partsModal.style.display = 'flex');
        closeModalBtn.addEventListener('click', () => partsModal.style.display = 'none');
        partsModal.addEventListener('click', (e) => {
            if(e.target === partsModal) {
                 partsModal.style.display = 'none';
            }
        });
        
        // Handle number formatting for printing
        const formatForPrint = () => {
            document.querySelectorAll('.quantity, .price, .price-jpy, .total-jpy, .total-twd, #mileslines-subtotal, #tax, #mileslines-total, #toshin-total, #grand-total').forEach(el => {
                const rawValue = el.tagName === 'INPUT' ? el.value.trim().replace(/,/g, '') : el.textContent.trim().replace(/,/g, '');
                el.dataset.originalValue = rawValue;
                const number = parseFloat(rawValue);
                if (!isNaN(number)) {
                    const formatted = new Intl.NumberFormat('zh-TW').format(number);
                    if (el.tagName === 'INPUT') {
                         el.value = formatted;
                    } else {
                         el.textContent = formatted;
                    }
                }
            });
        };

        const revertAfterPrint = () => {
            document.querySelectorAll('.quantity, .price, .price-jpy, .total-jpy, .total-twd, .total-jpy-input, #mileslines-subtotal, #tax, #mileslines-total, #toshin-total, #grand-total').forEach(el => {
                if (el.dataset.originalValue !== undefined) {
                     if (el.tagName === 'INPUT') {
                        el.value = el.dataset.originalValue;
                     } else {
                        el.textContent = el.dataset.originalValue;
                     }
                    delete el.dataset.originalValue;
                }
            });
        };

        window.addEventListener('beforeprint', formatForPrint);
        window.addEventListener('afterprint', revertAfterPrint);
        
        // Initial Page Load
        populateModal();
        customerSelect.dispatchEvent(new Event('change')); // Set initial customer data
        updatemileslinesSectionVisibility();
        updatetoshinSectionVisibility();
        const initialDate = new Date().toISOString().split('T')[0];
        createmileslinesItemRow(initialDate, mileslinesProductList[0].description, 1, mileslinesProductList[0].price);
        createtoshinItemRow(initialDate, "æ§åˆ¶å™¨ > åºåˆ—æ§åˆ¶å™¨ (PLC)", 1, 0);
        updateTotals();
    });
</script>
<script>
function validateNonNegative(input) {
  let errorId = input.id + "-error";
  let errorElem = document.getElementById(errorId);
  if (!errorElem) {
    errorElem = document.createElement("div");
    errorElem.id = errorId;
    errorElem.className = "error-message";
    input.parentNode.insertBefore(errorElem, input.nextSibling);
  }
  if (input.value !== "" && parseFloat(input.value) < 0) {
    input.classList.add("invalid");
    errorElem.textContent = "è«‹è¼¸å…¥éè² æ•¸å€¼";
    errorElem.style.display = "block";
  } else {
    input.classList.remove("invalid");
    errorElem.textContent = "";
    errorElem.style.display = "none";
  }
}
</script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><script>
function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const content = document.body.cloneNode(true);
    const buttons = content.querySelectorAll('.print-preview-button, .export-pdf-button');
    buttons.forEach(btn => btn.remove());

    doc.html(content, {
        callback: function (doc) {
            doc.save("Customer_Statement.pdf");
        },
        x: 10,
        y: 10,
        width: 180
    });
}
</script></body>
</html>
